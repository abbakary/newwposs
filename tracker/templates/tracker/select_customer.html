{% extends 'tracker/base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6"><h4>{{ page_title }}</h4></div>
      <div class="col-6">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'tracker:orders_list' %}">Orders</a></li>
          <li class="breadcrumb-item active">New Order</li>
        </ol>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Left Column: Order Type Selection -->
    <div class="col-lg-4">
      <div class="card shadow-sm order-type-selector-card">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-list me-2"></i>Order Type</h6>
        </div>
        <div class="card-body">
          <p class="small text-muted mb-3">Select how you want to create this order:</p>
          
          <div class="order-type-options d-flex flex-column gap-2">
            <!-- Service Order -->
            <div class="order-type-option-card" data-order-type="service">
              <div class="order-type-option-content">
                <i class="fa fa-wrench order-type-icon"></i>
                <div>
                  <h6 class="mb-1">Service Order</h6>
                  <small class="text-muted">Repair, maintenance, or service work</small>
                </div>
              </div>
              <i class="fa fa-chevron-right order-type-chevron"></i>
            </div>

            <!-- Sales Order -->
            <div class="order-type-option-card" data-order-type="sales">
              <div class="order-type-option-content">
                <i class="fa fa-shopping-cart order-type-icon"></i>
                <div>
                  <h6 class="mb-1">Sales Order</h6>
                  <small class="text-muted">Item purchase or product sale</small>
                </div>
              </div>
              <i class="fa fa-chevron-right order-type-chevron"></i>
            </div>

            <!-- Inquiry -->
            <div class="order-type-option-card" data-order-type="inquiry">
              <div class="order-type-option-content">
                <i class="fa fa-question-circle order-type-icon"></i>
                <div>
                  <h6 class="mb-1">Inquiry</h6>
                  <small class="text-muted">Customer question or information request</small>
                </div>
              </div>
              <i class="fa fa-chevron-right order-type-chevron"></i>
            </div>

            <hr class="my-2">

            <!-- Invoice Creation Options -->
            <p class="small text-muted mb-2 mt-3"><strong>Invoice Creation:</strong></p>

            <!-- Upload & Extract -->
            <div class="order-type-option-card" data-order-type="upload-extract">
              <div class="order-type-option-content">
                <i class="fa fa-file-upload order-type-icon"></i>
                <div>
                  <h6 class="mb-1">Upload & Extract</h6>
                  <small class="text-muted">Auto-extract data from PDF invoice</small>
                </div>
              </div>
              <i class="fa fa-chevron-right order-type-chevron"></i>
            </div>

            <!-- Manual Invoice -->
            <div class="order-type-option-card" data-order-type="manual-invoice">
              <div class="order-type-option-content">
                <i class="fa fa-pencil order-type-icon"></i>
                <div>
                  <h6 class="mb-1">Manual Invoice</h6>
                  <small class="text-muted">Manually enter invoice details</small>
                </div>
              </div>
              <i class="fa fa-chevron-right order-type-chevron"></i>
            </div>
          </div>

          <div id="selectedTypeInfo" class="alert alert-info mt-3" style="display:none;">
            <small><strong>Selected:</strong> <span id="selectedTypeName"></span></small>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Customer Selection & Order Creation -->
    <div class="col-lg-8">
      <div class="card shadow-sm customer-selector-card">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-users me-2"></i>Select Customer</h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Search for Customer</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="fa fa-search"></i>
              </span>
              <input type="text" class="form-control" id="customerSearch" placeholder="Search by name, phone, or email..." autocomplete="off">
            </div>
          </div>

          <div id="searchResults" class="list-group" style="display: none; max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
            <!-- Search results will be populated here -->
          </div>

          <div id="recentCustomers">
            <h6 class="mb-3"><i class="fa fa-history me-2"></i>Recent Customers</h6>
            <div id="recentCustomersList" class="list-group">
              <!-- Recent customers will be populated here -->
            </div>
          </div>

          <!-- Or Create New Customer -->
          <div class="mt-4 pt-3 border-top">
            <p class="small text-muted mb-2">Don't see the customer?</p>
            <a href="{% url 'tracker:customer_register' %}" class="btn btn-outline-primary btn-sm w-100">
              <i class="fa fa-plus me-1"></i>Create New Customer
            </a>
          </div>
        </div>
      </div>

      <!-- Action Info Panel -->
      <div class="card shadow-sm mt-3 action-info-card" id="actionInfoCard" style="display:none;">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="fa fa-info-circle me-2"></i>Ready to Proceed</h6>
        </div>
        <div class="card-body">
          <p class="mb-3">
            <strong>Order Type:</strong> <span id="actionOrderType" class="badge bg-primary"></span>
            <br>
            <strong>Customer:</strong> <span id="actionCustomerName" class="badge bg-info"></span>
          </p>
          <div id="actionButtons"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload Invoice Modal -->
<div class="modal fade" id="uploadInvoiceModalForNew" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title"><i class="fa fa-file-upload me-2"></i>Upload Invoice for Extraction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fa fa-info-circle me-2"></i>
          Upload a PDF invoice. We'll automatically extract customer and order information.
        </div>
        
        <div class="mb-3">
          <label class="form-label fw-bold">Select PDF File</label>
          <input type="file" id="invoicePdfFile" class="form-control" accept=".pdf" data-max-file-size="50485760">
          <small class="text-muted">PDF files only. Max 50MB.</small>
        </div>

        <div id="uploadError" class="alert alert-danger" style="display:none;" role="alert"></div>
        <div id="uploadProgress" class="progress" style="display:none;">
          <div class="progress-bar progress-bar-striped progress-bar-animated" id="uploadProgressBar" role="progressbar" style="width: 0%"></div>
        </div>
        <div id="extractionSuccess" class="alert alert-success" style="display:none;" role="alert">
          <i class="fa fa-check-circle me-2"></i>Data extracted successfully! Review details below.
        </div>

        <div id="extractedDataPreview" style="display:none;" class="card mt-3 border-success">
          <div class="card-header bg-light">
            <strong><i class="fa fa-check-circle me-2 text-success"></i>Extracted Information</strong>
          </div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-6">
                <small class="text-muted d-block">Customer Name</small>
                <p id="previewExtractedName" class="mb-2 fw-bold">-</p>
              </div>
              <div class="col-md-6">
                <small class="text-muted d-block">Phone</small>
                <p id="previewExtractedPhone" class="mb-2 fw-bold">-</p>
              </div>
              <div class="col-md-6">
                <small class="text-muted d-block">Invoice Number</small>
                <p id="previewExtractedInvNo" class="mb-2">-</p>
              </div>
              <div class="col-md-6">
                <small class="text-muted d-block">Invoice Date</small>
                <p id="previewExtractedInvDate" class="mb-2">-</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="uploadAndProcessBtn" class="btn btn-primary" style="display:none;">
          <i class="fa fa-check me-1"></i>Create Order & Invoice
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.order-type-selector-card {
  position: sticky;
  top: 20px;
}

.order-type-options {
  max-height: 600px;
  overflow-y: auto;
}

.order-type-option-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 15px;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.order-type-option-card:hover {
  border-color: #0d6efd;
  background-color: #f8f9fa;
  transform: translateX(5px);
}

.order-type-option-card.selected {
  border-color: #0d6efd;
  background-color: #cfe2ff;
  border-width: 2px;
}

.order-type-option-content {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.order-type-icon {
  font-size: 1.5rem;
  color: #0d6efd;
  min-width: 30px;
}

.order-type-option-card.selected .order-type-icon {
  color: #0b5ed7;
}

.order-type-option-card h6 {
  margin: 0;
  font-weight: 600;
  color: #212529;
}

.order-type-option-card small {
  display: block;
}

.order-type-chevron {
  color: #6c757d;
  font-size: 1.2rem;
  transition: color 0.3s ease;
}

.order-type-option-card.selected .order-type-chevron {
  color: #0b5ed7;
}

.customer-selector-card {
  min-height: 400px;
}

.action-info-card {
  border-left: 4px solid #198754;
}

@media (max-width: 992px) {
  .order-type-selector-card {
    position: relative;
    top: auto;
  }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('customerSearch');
  const searchResults = document.getElementById('searchResults');
  const recentCustomersList = document.getElementById('recentCustomersList');
  const orderTypeOptions = document.querySelectorAll('.order-type-option-card');
  const selectedTypeInfo = document.getElementById('selectedTypeInfo');
  const selectedTypeName = document.getElementById('selectedTypeName');
  const actionInfoCard = document.getElementById('actionInfoCard');
  const actionOrderType = document.getElementById('actionOrderType');
  const actionCustomerName = document.getElementById('actionCustomerName');
  const actionButtons = document.getElementById('actionButtons');
  
  let selectedOrderType = null;
  let selectedCustomer = null;
  let searchTimeout = null;

  // Load recent customers on page load
  loadRecentCustomers();

  // Order type selection
  orderTypeOptions.forEach(option => {
    option.addEventListener('click', function() {
      orderTypeOptions.forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      selectedOrderType = this.dataset.orderType;
      
      selectedTypeInfo.style.display = 'block';
      selectedTypeName.textContent = this.querySelector('h6').textContent;
      updateActionButtons();
    });
  });

  // Load recent customers
  function loadRecentCustomers() {
    fetch(`/tracker/customers/search/?recent=1`)
      .then(response => response.json())
      .then(data => {
        if (data.results && data.results.length > 0) {
          recentCustomersList.innerHTML = '';
          data.results.forEach(customer => {
            const item = createCustomerItem(customer);
            recentCustomersList.appendChild(item);
          });
        } else {
          recentCustomersList.innerHTML = '<div class="list-group-item text-muted">No recent customers found</div>';
        }
      })
      .catch(error => {
        console.error('Error loading recent customers:', error);
        recentCustomersList.innerHTML = '<div class="list-group-item text-danger">Error loading recent customers</div>';
      });
  }

  // Create customer item element
  function createCustomerItem(customer) {
    const item = document.createElement('button');
    item.type = 'button';
    item.className = 'list-group-item list-group-item-action';
    item.innerHTML = `
      <div class="d-flex w-100 justify-content-between">
        <h6 class="mb-1">${customer.full_name || customer.name}</h6>
        <small class="badge bg-secondary">#${customer.code || customer.id}</small>
      </div>
      <div class="d-flex justify-content-between">
        <small class="text-muted">
          <i class="fa fa-phone me-1"></i>${customer.phone || 'No phone'}
        </small>
        <small class="text-muted">
          <i class="fa fa-envelope me-1"></i>${customer.email || 'No email'}
        </small>
      </div>
      <div class="mt-1">
        <span class="badge bg-light text-dark">${customer.customer_type_display || 'Personal'}</span>
        ${customer.total_visits ? `<span class="badge bg-info ms-1">${customer.total_visits} visits</span>` : ''}
      </div>
    `;
    item.addEventListener('click', () => selectCustomer(customer));
    return item;
  }

  // Select customer
  function selectCustomer(customer) {
    selectedCustomer = customer;
    updateActionButtons();
  }

  // Update action buttons based on selection
  function updateActionButtons() {
    if (!selectedOrderType || !selectedCustomer) {
      actionInfoCard.style.display = 'none';
      return;
    }

    actionInfoCard.style.display = 'block';
    actionOrderType.textContent = getOrderTypeLabel(selectedOrderType);
    actionCustomerName.textContent = selectedCustomer.full_name || selectedCustomer.name;

    let buttonsHTML = '';

    if (selectedOrderType === 'upload-extract') {
      buttonsHTML = `
        <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#uploadInvoiceModalForNew">
          <i class="fa fa-file-upload me-2"></i>Upload Invoice & Extract
        </button>
      `;
    } else if (selectedOrderType === 'manual-invoice') {
      buttonsHTML = `
        <a href="/tracker/invoices/create/?customer_id=${selectedCustomer.id}" class="btn btn-primary w-100">
          <i class="fa fa-pencil me-2"></i>Create Manual Invoice
        </a>
      `;
    } else {
      buttonsHTML = `
        <a href="/tracker/customers/${selectedCustomer.id}/order/new/?type=${selectedOrderType}" class="btn btn-primary w-100">
          <i class="fa fa-plus me-2"></i>Create ${getOrderTypeLabel(selectedOrderType)}
        </a>
      `;
    }

    actionButtons.innerHTML = buttonsHTML;
  }

  // Get order type label
  function getOrderTypeLabel(type) {
    const labels = {
      'service': 'Service Order',
      'sales': 'Sales Order',
      'inquiry': 'Inquiry',
      'upload-extract': 'Upload & Extract',
      'manual-invoice': 'Manual Invoice'
    };
    return labels[type] || type;
  }

  // Search for customers with debounce
  function searchCustomers() {
    const query = searchInput.value.trim();

    clearTimeout(searchTimeout);

    if (query.length === 0) {
      searchResults.style.display = 'none';
      document.getElementById('recentCustomers').style.display = 'block';
      return;
    }

    if (query.length < 2) {
      searchResults.style.display = 'none';
      return;
    }

    searchResults.innerHTML = '<div class="list-group-item text-center"><i class="fa fa-spinner fa-spin me-2"></i>Searching...</div>';
    searchResults.style.display = 'block';
    document.getElementById('recentCustomers').style.display = 'none';

    searchTimeout = setTimeout(() => {
      fetch(`/tracker/customers/search/?q=${encodeURIComponent(query)}&details=1`)
        .then(response => response.json())
        .then(data => {
          if (data.results && data.results.length > 0) {
            searchResults.innerHTML = '';
            data.results.forEach(customer => {
              const item = createCustomerItem(customer);
              searchResults.appendChild(item);
            });
          } else {
            searchResults.innerHTML = '<div class="list-group-item text-center text-muted">No customers found matching your search</div>';
          }
        })
        .catch(error => {
          console.error('Error searching customers:', error);
          searchResults.innerHTML = '<div class="list-group-item text-center text-danger">Error loading customers</div>';
        });
    }, 300);
  }

  // Event listeners
  searchInput.addEventListener('input', searchCustomers);
  searchInput.addEventListener('focus', function() {
    if (searchInput.value.trim().length >= 2) {
      searchResults.style.display = 'block';
      document.getElementById('recentCustomers').style.display = 'none';
    }
  });

  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      searchResults.style.display = 'none';
      document.getElementById('recentCustomers').style.display = 'block';
    }
  });

  // Upload invoice handling
  const uploadInvoiceModal = document.getElementById('uploadInvoiceModalForNew');
  const invoicePdfFile = document.getElementById('invoicePdfFile');
  const uploadError = document.getElementById('uploadError');
  const uploadProgress = document.getElementById('uploadProgress');
  const uploadProgressBar = document.getElementById('uploadProgressBar');
  const extractionSuccess = document.getElementById('extractionSuccess');
  const extractedDataPreview = document.getElementById('extractedDataPreview');
  const uploadAndProcessBtn = document.getElementById('uploadAndProcessBtn');

  let uploadedFileData = null;

  invoicePdfFile.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    uploadError.style.display = 'none';
    uploadProgress.style.display = 'block';
    uploadProgressBar.style.width = '0%';
    extractionSuccess.style.display = 'none';
    extractedDataPreview.style.display = 'none';

    const formData = new FormData();
    formData.append('file', file);

    try {
      uploadProgressBar.style.width = '50%';

      const response = await fetch('/tracker/api/invoices/extract/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
      });

      uploadProgressBar.style.width = '100%';

      const result = await response.json();

      if (result.success) {
        uploadedFileData = result.data;
        
        // Show extracted data
        document.getElementById('previewExtractedName').textContent = result.data.customer_name || '-';
        document.getElementById('previewExtractedPhone').textContent = result.data.customer_phone || '-';
        document.getElementById('previewExtractedInvNo').textContent = result.data.invoice_number || '-';
        document.getElementById('previewExtractedInvDate').textContent = result.data.invoice_date || '-';
        
        extractionSuccess.style.display = 'block';
        extractedDataPreview.style.display = 'block';
        uploadAndProcessBtn.style.display = 'block';
      } else {
        uploadError.textContent = result.message || 'Error extracting invoice data';
        uploadError.style.display = 'block';
      }
    } catch (err) {
      console.error('Upload error:', err);
      uploadError.textContent = 'Error uploading file: ' + err.message;
      uploadError.style.display = 'block';
    } finally {
      uploadProgress.style.display = 'none';
    }
  });

  uploadAndProcessBtn.addEventListener('click', function() {
    if (!selectedCustomer || !uploadedFileData) {
      alert('Please select a customer first');
      return;
    }

    // Redirect to invoice creation with extracted data
    const params = new URLSearchParams({
      customer_id: selectedCustomer.id,
      invoice_number: uploadedFileData.invoice_number || '',
      invoice_date: uploadedFileData.invoice_date || '',
      extracted_data: JSON.stringify(uploadedFileData)
    });

    window.location.href = `/tracker/invoices/create/?${params.toString()}`;
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
{% endblock %}
