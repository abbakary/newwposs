{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}

{% block title %}Order {{ order.order_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-md-8">
        <h4>
          <i class="fa fa-play me-2"></i>Order {{ order.order_number }}
          {% if vehicle %}
            <small class="text-muted ms-2"><i class="fa fa-car"></i> {{ vehicle.plate_number }}</small>
          {% endif %}
        </h4>
      </div>
      <div class="col-md-4">
        <ol class="breadcrumb justify-content-end">
          <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><i class="fa fa-home"></i></a></li>
          <li class="breadcrumb-item"><a href="{% url 'tracker:started_orders_dashboard' %}">Started Orders</a></li>
          <li class="breadcrumb-item active">{{ order.order_number }}</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-left border-4" style="border-left-color: #667eea;">
        <div class="card-body py-3">
          <div class="row align-items-center">
            <div class="col-md-6">
              <p class="mb-2"><strong>Status:</strong> <span class="badge bg-secondary">New</span></p>
              <p class="mb-0"><strong>Started:</strong> <span class="text-muted">{{ order.started_at|date:"M d, Y H:i" }}</span></p>
            </div>
            <div class="col-md-6 text-md-end">
              <p class="mb-2"><strong>Type:</strong> 
                {% if order.type == 'service' %}
                  <span class="badge bg-primary"><i class="fa fa-wrench me-1"></i>Service</span>
                {% elif order.type == 'sales' %}
                  <span class="badge bg-success"><i class="fa fa-shopping-cart me-1"></i>Sales</span>
                {% else %}
                  <span class="badge bg-secondary">{{ order.type }}</span>
                {% endif %}
              </p>
              <p class="mb-0"><strong>Progress:</strong> <span class="text-muted">Step 1 of 3</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Action Buttons -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-3 justify-content-center">
            <!-- Customer and Vehicle Info -->
            <div class="btn-group" role="group">
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('customer')">
                <i class="fa fa-user me-2"></i>Customer Info
              </button>
              {% if vehicle %}
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('vehicle')">
                <i class="fa fa-car me-2"></i>Vehicle Info
              </button>
              {% endif %}
            </div>

            <!-- Order Management -->
            <div class="btn-group" role="group">
              <a href="{% url 'tracker:invoice_create_from_order' order_id=order.id %}" class="btn btn-primary">
                <i class="fa fa-plus me-2"></i>Create Invoice
              </a>
              <button type="button" id="editOrderDetailsBtn" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editOrderDetailsModal">
                <i class="fa fa-list me-2"></i>Edit Details
              </button>
            </div>

            <!-- Complete Order -->
            <button type="button" id="completeOrderBtn" class="btn btn-success">
              <i class="fa fa-check me-2"></i>Complete Order
            </button>
          </div>

          <!-- Overrun Reason Modal -->
          <div class="modal fade" id="overrunReasonModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                  <h5 class="modal-title">Order Overrun Reason</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <p class="mb-2">This service order has exceeded the expected time. Please provide a reason before completing.</p>
                  <div class="mb-3">
                    <label class="form-label">Reason</label>
                    <textarea id="overrunReasonInput" class="form-control" rows="4" placeholder="Explain why this order exceeded its ETA (required)"></textarea>
                    <div id="overrunReasonError" class="text-danger mt-2" style="display:none;"></div>
                  </div>
                </div>
                <div class="modal-footer bg-light">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" id="saveOverrunReasonBtn" class="btn btn-warning">Save & Continue to Complete</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Edit Order Details Modal -->
          <div class="modal fade" id="editOrderDetailsModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title"><i class="fa fa-list me-2"></i>Edit Order Details</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="orderDetailsForm" method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="update_order_details">
                  <div class="modal-body">
                    <!-- Item Selection for Sales Orders -->
                    <div id="itemSelectionSection" class="mb-3" style="display:none;">
                      <label class="form-label fw-bold">Select Item</label>
                      <select id="editOrderItemSelect" name="item_id" class="form-select mb-2">
                        <option value="">Loading items...</option>
                      </select>
                      <div class="row g-2">
                        <div class="col-md-6">
                          <label class="form-label">Brand</label>
                          <input type="text" id="editOrderBrand" name="item_brand" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Quantity</label>
                          <input type="number" id="editOrderQuantity" name="item_quantity" class="form-control" value="1" min="1">
                        </div>
                      </div>
                    </div>

                    <!-- Services/Add-ons Section -->
                    <div id="servicesAddonsSection" class="mb-3">
                      <label class="form-label fw-bold" id="editOrderOptionsLabel">Select Services</label>
                      <div id="orderServicesContainer" class="row g-2">Loading services...</div>
                      <div class="small text-muted mt-2" id="editOrderEtaHint" style="display:none;"></div>
                    </div>

                    <!-- Duration -->
                    <div class="mb-3">
                      <label class="form-label fw-bold">Estimated Duration (minutes)</label>
                      <input type="number" name="estimated_duration" id="orderEstimatedDuration" class="form-control" value="{{ order.estimated_duration|default:'' }}" min="0">
                    </div>
                    <div class="mb-2 text-muted small" id="editOrderHelpText">Selected services will be appended to the order description for quick reference.</div>
                  </div>
                  <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <script>
            // Populate options in Edit Order Details modal
            document.getElementById('editOrderDetailsBtn').addEventListener('click', function(){
              const container = document.getElementById('orderServicesContainer');
              const label = document.getElementById('editOrderOptionsLabel');
              const itemSection = document.getElementById('itemSelectionSection');
              const itemSelect = document.getElementById('editOrderItemSelect');
              const brandField = document.getElementById('editOrderBrand');
              const helpText = document.getElementById('editOrderHelpText');
              const helpSalesText = 'Selected item and add-ons will be saved to the order. Add-ons will be appended to the order description.';
              const helpServiceText = 'Selected services will be appended to the order description for quick reference.';

              container.innerHTML = 'Loading...';
              fetch('{% url "tracker:api_service_types" %}', { method: 'GET', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 'X-Requested-With': 'XMLHttpRequest' }})
                .then(r => {
                  if (!r.ok) {
                    console.error('API response not ok:', r.status, r.statusText);
                  }
                  return r.json();
                })
                .then(data => {
                  console.log('API response data:', data);
                  container.innerHTML = '';
                  const existingDesc = `{{ order.description|default:'' }}`.toLowerCase();
                  const orderType = ('{{ order.type|default:'' }}').toLowerCase();
                  const serviceTypes = Array.isArray(data.service_types) ? data.service_types : [];
                  const addOns = Array.isArray(data.service_addons) ? data.service_addons : [];
                  const inventoryItems = Array.isArray(data.inventory_items) ? data.inventory_items : [];
                  console.log('Inventory items loaded:', inventoryItems.length, inventoryItems);

                  function renderCheckbox(name, mins, isChecked, extraBadge){
                    const safe = (name||'').replace(/[^A-Za-z0-9_]/g,'_');
                    const id = 'od_opt_' + safe;
                    const col = document.createElement('div'); col.className = 'col-md-6';
                    const badge = extraBadge ? ` <span class="badge bg-light text-dark ms-1">${extraBadge}</span>` : '';
                    col.innerHTML = `<div class="form-check">
                      <input class="form-check-input od-option" type="checkbox" id="${id}" name="services" value="${name}" data-minutes="${mins||0}" ${isChecked?'checked':''}>
                      <label class="form-check-label" for="${id}">${name} <span class="text-muted small">(${mins||0}m)</span>${badge}</label>
                    </div>`;
                    container.appendChild(col);
                  }

                  if (orderType === 'sales') {
                    // Show item selection for sales orders
                    itemSection.style.display = 'block';
                    label.textContent = 'Select Add-ons';
                    helpText.textContent = helpSalesText;

                    // Populate item selection
                    itemSelect.innerHTML = '<option value="">Select item</option>';
                    if (inventoryItems.length > 0) {
                      console.log('Adding', inventoryItems.length, 'items to dropdown');
                      inventoryItems.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.brand} - ${item.name}`;
                        option.setAttribute('data-brand', item.brand);
                        itemSelect.appendChild(option);
                      });
                    } else {
                      console.warn('No inventory items available');
                      itemSelect.innerHTML += '<option value="" disabled>No items available</option>';
                    }

                    // Set existing item if available
                    const existingItem = ('{{ order.item_name|default:"" }}').trim();
                    const existingBrand = ('{{ order.brand|default:"" }}').trim();
                    console.log('Existing item:', existingItem, 'Brand:', existingBrand);
                    if (existingItem && inventoryItems.length > 0) {
                      const selectedItem = inventoryItems.find(i => i.name === existingItem && i.brand === existingBrand);
                      if (selectedItem) {
                        console.log('Setting selected item:', selectedItem);
                        itemSelect.value = selectedItem.id;
                        brandField.value = selectedItem.brand;
                      }
                    }

                    // Show add-ons for sales
                    if (addOns.length) {
                      addOns.forEach(add => {
                        const checked = existingDesc.indexOf((add.name||'').toLowerCase()) !== -1;
                        renderCheckbox(add.name, add.estimated_minutes||0, checked, 'Addon');
                      });
                    } else {
                      container.innerHTML = '<div class="text-muted">No add-ons available</div>';
                    }
                  } else {
                    // Hide item selection for service/inquiry orders
                    itemSection.style.display = 'none';
                    label.textContent = 'Select Services';
                    helpText.textContent = helpServiceText;

                    if (serviceTypes.length) {
                      serviceTypes.forEach(svc => {
                        const checked = existingDesc.indexOf((svc.name||'').toLowerCase()) !== -1;
                        renderCheckbox(svc.name, svc.estimated_minutes||0, checked, '');
                      });
                    } else {
                      container.innerHTML = '<div class="text-muted">No services available</div>';
                    }
                    // Also show add-ons below services if present
                    if (addOns.length) {
                      const hr = document.createElement('div'); hr.className = 'col-12 mt-2'; hr.innerHTML = '<hr>'; container.appendChild(hr);
                      addOns.forEach(add => {
                        const checked = existingDesc.indexOf((add.name||'').toLowerCase()) !== -1;
                        renderCheckbox(add.name, add.estimated_minutes||0, checked, 'Addon');
                      });
                    }
                  }

                  // Handle item selection change
                  itemSelect.addEventListener('change', function(){
                    console.log('Item selection changed:', this.value);
                    if (this.value) {
                      const selectedItem = inventoryItems.find(i => i.id === parseInt(this.value));
                      console.log('Selected item found:', selectedItem);
                      if (selectedItem) {
                        console.log('Setting brand field to:', selectedItem.brand);
                        brandField.value = selectedItem.brand;
                      }
                    } else {
                      console.log('Clearing brand field');
                      brandField.value = '';
                    }
                  });

                  // Attach change listeners for ETA
                  container.querySelectorAll('.od-option').forEach(cb => cb.addEventListener('change', updateEditOrderEta));
                  // Initialize ETA on open
                  updateEditOrderEta();
                })
                .catch(err => {
                  console.error('Failed to fetch API:', err);
                  container.innerHTML = '<div class="text-danger">Failed to load options</div>';
                });
            });

            function updateEditOrderEta(){
              const hint = document.getElementById('editOrderEtaHint');
              const etaInput = document.getElementById('orderEstimatedDuration');
              let total = 0;
              document.querySelectorAll('#orderServicesContainer .od-option:checked').forEach(cb => {
                const m = parseInt(cb.getAttribute('data-minutes')||'0',10); if(!isNaN(m)) total += m;
              });
              if (etaInput) { etaInput.value = total > 0 ? String(total) : (etaInput.value || ''); }
              if (hint){
                if (total>0){ hint.style.display='block'; hint.textContent = 'Estimated total time: ' + total + ' mins'; }
                else { hint.style.display='none'; hint.textContent=''; }
              }
            }
          </script>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
        <i class="fa fa-eye me-2"></i>Overview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">
        <i class="fa fa-file me-2"></i>Documents <span class="badge bg-danger ms-1">{{ documents.count }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
        <i class="fa fa-list me-2"></i>Order Details
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-user me-2"></i>Customer Information</h6>
            </div>
            <div class="card-body">
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Name</small>
                  <strong>{{ customer.full_name }}</strong>
                </div>
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Phone</small>
                  <strong><a href="tel:{{ customer.phone }}">{{ customer.phone }}</a></strong>
                </div>
                {% if customer.email %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Email</small>
                  <strong><a href="mailto:{{ customer.email }}">{{ customer.email }}</a></strong>
                </div>
                {% endif %}
                {% if customer.address %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Address</small>
                  <strong>{{ customer.address }}</strong>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-car me-2"></i>Vehicle Information</h6>
            </div>
            <div class="card-body">
              {% if vehicle %}
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Plate Number</small>
                  <strong>{{ vehicle.plate_number }}</strong>
                </div>
                {% if vehicle.make %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Make</small>
                  <strong>{{ vehicle.make }}</strong>
                </div>
                {% endif %}
                {% if vehicle.model %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Model</small>
                  <strong>{{ vehicle.model }}</strong>
                </div>
                {% endif %}
                {% if vehicle.vehicle_type %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Type</small>
                  <strong>{{ vehicle.vehicle_type }}</strong>
                </div>
                {% endif %}
              </div>
              {% else %}
              <div class="alert alert-warning" role="alert">
                <i class="fa fa-exclamation-triangle me-2"></i>No vehicle information
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-pane fade" id="documents">
      <!-- Document Upload Section -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-cloud-upload me-2"></i>Upload Invoice/Document</h6>
        </div>
        <div class="card-body">
          <form id="documentUploadForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label">Select Document (PDF preferred)</label>
              <div class="input-group">
                <input type="file" id="documentUploadInput" name="document" accept=".pdf,.txt,.png,.jpg,.jpeg" class="form-control" required>
                <button class="btn btn-primary" type="button" id="uploadDocumentBtn" onclick="uploadDocument()">
                  <i class="fa fa-upload me-1"></i>Upload & Extract
                </button>
              </div>
              <small class="text-muted d-block mt-2">Supported formats: PDF (recommended), Text files, Images. System will extract customer, vehicle, and invoice details automatically.</small>
            </div>
            <div id="uploadProgressContainer" style="display:none;">
              <div class="progress mb-2">
                <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
              </div>
              <small id="uploadStatusText" class="text-muted">Uploading and processing document...</small>
            </div>
          </form>
        </div>
      </div>

      <!-- Uploaded Documents -->
      {% if documents %}
      <div class="row g-3">
        {% for doc in documents %}
        <div class="col-lg-6">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1"><i class="fa fa-file-pdf me-2" style="color: #dc3545;"></i>{{ doc.file_name }}</h6>
                <small class="text-muted">
                  {{ doc.document_type|upper }} â€¢ {{ doc.uploaded_at|date:"M d, Y H:i" }}
                </small>
              </div>
              <span class="badge bg-{% if doc.extraction_status == 'completed' %}success{% elif doc.extraction_status == 'processing' %}warning{% else %}danger{% endif %}">
                {{ doc.extraction_status|title }}
              </span>
            </div>

            {% if doc.extraction %}
            <div class="card-body">
              <!-- Extracted Data Summary -->
              <div class="extraction-summary mb-3">
                <div class="row g-2">
                  {% if doc.extraction.extracted_customer_name %}
                  <div class="col-12">
                    <small class="text-muted d-block">Customer Name</small>
                    <strong>{{ doc.extraction.extracted_customer_name }}</strong>
                  </div>
                  {% endif %}
                  {% if doc.extraction.extracted_customer_phone %}
                  <div class="col-12">
                    <small class="text-muted d-block">Customer Phone</small>
                    <strong>{{ doc.extraction.extracted_customer_phone }}</strong>
                  </div>
                  {% endif %}
                  {% if doc.extraction.extracted_vehicle_plate %}
                  <div class="col-12">
                    <small class="text-muted d-block">Vehicle Plate</small>
                    <strong>{{ doc.extraction.extracted_vehicle_plate }}</strong>
                  </div>
                  {% endif %}
                  {% if doc.extraction.extracted_order_description %}
                  <div class="col-12">
                    <small class="text-muted d-block">Service Description</small>
                    <strong>{{ doc.extraction.extracted_order_description }}</strong>
                  </div>
                  {% endif %}
                  {% if doc.extraction.code_no %}
                  <div class="col-12">
                    <small class="text-muted d-block">Code No</small>
                    <strong>{{ doc.extraction.code_no }}</strong>
                  </div>
                  {% endif %}
                  {% if doc.extraction.reference %}
                  <div class="col-12">
                    <small class="text-muted d-block">Reference</small>
                    <strong>{{ doc.extraction.reference }}</strong>
                  </div>
                  {% endif %}
                  {% if doc.extraction.net_value %}
                  <div class="col-md-6">
                    <small class="text-muted d-block">Net Value</small>
                    <strong>{{ doc.extraction.net_value }}</strong>
                  </div>
                  {% endif %}
                  {% if doc.extraction.vat_amount %}
                  <div class="col-md-6">
                    <small class="text-muted d-block">VAT Amount</small>
                    <strong>{{ doc.extraction.vat_amount }}</strong>
                  </div>
                  {% endif %}
                  {% if doc.extraction.gross_value %}
                  <div class="col-12">
                    <small class="text-muted d-block">Gross Value</small>
                    <strong style="font-size: 1.1em; color: #28a745;">{{ doc.extraction.gross_value }}</strong>
                  </div>
                  {% endif %}
                </div>
              </div>

              <!-- Extracted Line Items -->
              {% if doc.extraction.items.all %}
              <div class="extracted-items mb-3">
                <small class="text-muted d-block mb-2"><strong>Extracted Items:</strong></small>
                <div class="table-responsive">
                  <table class="table table-sm table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th>Code</th>
                        <th>Description</th>
                        <th>Qty</th>
                        <th>Unit</th>
                        <th>Rate</th>
                        <th>Value</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in doc.extraction.items.all %}
                      <tr>
                        <td>{{ item.code|default:"-" }}</td>
                        <td>{{ item.description|default:"-" }}</td>
                        <td>{{ item.qty|default:"-" }}</td>
                        <td>{{ item.unit|default:"-" }}</td>
                        <td>{{ item.rate|default:"-" }}</td>
                        <td>{{ item.value|default:"-" }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% endif %}

              <!-- Action Buttons -->
              <div class="button-group d-flex gap-2">
                <button type="button" class="btn btn-sm btn-primary flex-fill" onclick="applyExtractionToOrder({{ doc.extraction.id }})">
                  <i class="fa fa-check me-1"></i>Apply to Order
                </button>
                <button type="button" class="btn btn-sm btn-success flex-fill" onclick="showCreateInvoiceModal({{ doc.extraction.id }})">
                  <i class="fa fa-file-invoice me-1"></i>Create Invoice
                </button>
              </div>
            </div>
            {% else %}
            <div class="card-body">
              {% if doc.extraction_status == 'processing' %}
              <div class="text-center">
                <div class="spinner-border spinner-border-sm text-warning" role="status">
                  <span class="visually-hidden">Processing...</span>
                </div>
                <p class="text-muted mt-2">Extracting document data...</p>
              </div>
              <script>
                setTimeout(function() { location.reload(); }, 2000);
              </script>
              {% elif doc.extraction_status == 'failed' %}
              <div class="alert alert-danger" role="alert">
                <i class="fa fa-exclamation-triangle me-2"></i>
                <strong>Extraction Failed</strong>
                <p class="mb-0 small">{{ doc.extraction_error }}</p>
              </div>
              {% else %}
              <p class="text-muted">Document uploaded but extraction not started yet.</p>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-info text-center" role="alert">
        <i class="fa fa-info-circle me-2"></i>
        <strong>No documents uploaded yet.</strong> Upload an invoice or quotation to get started.
      </div>
      {% endif %}
    </div>

    <!-- Details Tab -->
    <div class="tab-pane fade" id="details">
      <div class="card shadow-sm">
        <div class="card-body">
          {% if order.description %}
          <div class="mb-3">
            <small class="text-muted d-block">Description</small>
            <strong>{{ order.description }}</strong>
          </div>
          {% endif %}
          {% if order.estimated_duration %}
          <div class="mb-3">
            <small class="text-muted d-block">Estimated Duration</small>
            <strong>{{ order.estimated_duration }} minutes</strong>
          </div>
          {% endif %}
          {% if order.item_name %}
          <div class="mb-3">
            <small class="text-muted d-block">Item</small>
            <strong>{{ order.item_name }}</strong>
          </div>
          {% endif %}
          {% if order.brand %}
          <div class="mb-3">
            <small class="text-muted d-block">Brand</small>
            <strong>{{ order.brand }}</strong>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Create Invoice from Extraction Modal -->
<div class="modal fade" id="createInvoiceFromExtractionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="fa fa-file-invoice me-2"></i>Create Invoice from Extracted Data</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="createInvoiceForm" method="post">
        {% csrf_token %}
        <input type="hidden" name="extraction_id" id="invoiceExtractionId">
        <div class="modal-body">
          <!-- Preview of Extracted Data -->
          <div class="card mb-3 bg-light">
            <div class="card-body py-2">
              <small class="text-muted d-block"><strong>Extracted Data Summary:</strong></small>
              <div class="row g-2 mt-2">
                <div class="col-md-6">
                  <small class="text-muted d-block">Customer</small>
                  <code id="previewCustomer">-</code>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Vehicle Plate</small>
                  <code id="previewPlate">-</code>
                </div>
                <div class="col-12">
                  <small class="text-muted d-block">Service Description</small>
                  <code id="previewDescription">-</code>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Net Value</small>
                  <code id="previewNetValue">-</code>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">VAT Amount</small>
                  <code id="previewVatAmount">-</code>
                </div>
              </div>
            </div>
          </div>

          <!-- Invoice Form Fields -->
          <div class="mb-3">
            <label class="form-label fw-bold">Reference (e.g., PO Number, Plate)</label>
            <input type="text" name="reference" id="invoiceReference" class="form-control" placeholder="Leave empty to auto-fill">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Due Date</label>
            <input type="date" name="due_date" id="invoiceDueDate" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Tax Rate (%)</label>
            <input type="number" name="tax_rate" id="invoiceTaxRate" class="form-control" step="0.01" min="0" max="100" value="0">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Attended By</label>
            <input type="text" name="attended_by" id="invoiceAttendedBy" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Kind Attention</label>
            <input type="text" name="kind_attention" id="invoiceKindAttention" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Notes</label>
            <textarea name="notes" id="invoiceNotes" class="form-control" rows="2"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Terms & Conditions</label>
            <textarea name="terms" id="invoiceTerms" class="form-control" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="submitCreateInvoiceForm()">
            <i class="fa fa-check me-1"></i>Create Invoice
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Unified Edit Details Modal -->
<div class="modal fade" id="editDetailsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="fa fa-edit me-2"></i><span id="editTitle">Edit Details</span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <!-- Customer Edit Form -->
      <form id="customerEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_customer">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Full Name</label>
            <input type="text" name="full_name" class="form-control" value="{{ customer.full_name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Phone</label>
            <input type="tel" name="phone" class="form-control" value="{{ customer.phone }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Email</label>
            <input type="email" name="email" class="form-control" value="{{ customer.email|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Address</label>
            <textarea name="address" class="form-control" rows="2">{{ customer.address|default:'' }}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Customer Type</label>
            <select name="customer_type" id="editCustomerType" class="form-select">
              <option value="personal" {% if customer.customer_type == 'personal' %}selected{% endif %}>Personal</option>
              <option value="company" {% if customer.customer_type == 'company' %}selected{% endif %}>Company</option>
              <option value="government" {% if customer.customer_type == 'government' %}selected{% endif %}>Government</option>
              <option value="ngo" {% if customer.customer_type == 'ngo' %}selected{% endif %}>NGO</option>
            </select>
          </div>
          <div class="mb-3 {% if customer.customer_type != 'personal' %}d-none{% endif %}" id="editPersonalSubtypeField">
            <label class="form-label fw-bold">Personal Subtype</label>
            <select name="personal_subtype" class="form-select">
              <option value="owner" {% if customer.personal_subtype == 'owner' %}selected{% endif %}>Owner</option>
              <option value="driver" {% if customer.personal_subtype == 'driver' %}selected{% endif %}>Driver</option>
            </select>
          </div>
          <div class="mb-3 {% if customer.customer_type == 'personal' %}d-none{% endif %}" id="editOrganizationField">
            <label class="form-label fw-bold">Organization Name</label>
            <input type="text" name="organization_name" class="form-control" value="{{ customer.organization_name|default:'' }}">
          </div>
          <div class="mb-3 {% if customer.customer_type == 'personal' %}d-none{% endif %}" id="editTaxField">
            <label class="form-label fw-bold">Tax Number (TIN)</label>
            <input type="text" name="tax_number" class="form-control" value="{{ customer.tax_number|default:'' }}">
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>

      <!-- Vehicle Edit Form -->
      {% if vehicle %}
      <form id="vehicleEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_vehicle">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Plate Number</label>
            <input type="text" class="form-control" value="{{ vehicle.plate_number }}" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Vehicle Type</label>
            <input type="text" name="vehicle_type" class="form-control" value="{{ vehicle.vehicle_type|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Make</label>
            <input type="text" name="make" class="form-control" value="{{ vehicle.make|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Model</label>
            <input type="text" name="model" class="form-control" value="{{ vehicle.model|default:'' }}">
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<script>
let currentEditMode = 'customer';

function setEditMode(mode) {
  currentEditMode = mode;
  
  // Hide all forms
  document.getElementById('customerEditForm').style.display = 'none';
  if (document.getElementById('vehicleEditForm')) {
    document.getElementById('vehicleEditForm').style.display = 'none';
  }
  
  // Show selected form
  if (mode === 'customer') {
    document.getElementById('editTitle').textContent = 'Edit Customer Information';
    document.getElementById('customerEditForm').style.display = 'block';
    // Initialize extra fields visibility when switching to customer form
    if (typeof toggleCustomerExtraFields === 'function') { toggleCustomerExtraFields(); }
  } else if (mode === 'vehicle') {
    document.getElementById('editTitle').textContent = 'Edit Vehicle Information';
    document.getElementById('vehicleEditForm').style.display = 'block';
  }
}

// Dynamically show/hide fields based on customer type
function toggleCustomerExtraFields(){
  var sel = document.getElementById('editCustomerType');
  var type = sel ? String(sel.value).toLowerCase() : '';
  var personal = document.getElementById('editPersonalSubtypeField');
  var org = document.getElementById('editOrganizationField');
  var tax = document.getElementById('editTaxField');
  if (personal) {
    if (type === 'personal') { personal.classList.remove('d-none'); } else { personal.classList.add('d-none'); }
  }
  var showOrg = (type === 'company' || type === 'government' || type === 'ngo');
  if (org) { if (showOrg) { org.classList.remove('d-none'); } else { org.classList.add('d-none'); } }
  if (tax) { if (showOrg) { tax.classList.remove('d-none'); } else { tax.classList.add('d-none'); } }
}

// Attach change listener once DOM is ready
document.addEventListener('DOMContentLoaded', function(){
  var sel = document.getElementById('editCustomerType');
  if (sel) {
    sel.addEventListener('change', toggleCustomerExtraFields);
    toggleCustomerExtraFields();
  }
  // Also wire up when the modal opens, to handle dynamic DOM/visibility
  var editModal = document.getElementById('editDetailsModal');
  if (editModal) {
    editModal.addEventListener('shown.bs.modal', function(){
      var typeSel = document.getElementById('editCustomerType');
      if (typeSel) {
        // avoid double-binding by removing existing then adding
        typeSel.removeEventListener('change', toggleCustomerExtraFields);
        typeSel.addEventListener('change', toggleCustomerExtraFields);
        toggleCustomerExtraFields();
      }
    });
  }
});

// Complete Order Logic
document.addEventListener('DOMContentLoaded', function(){
  const completeBtn = document.getElementById('completeOrderBtn');
  if (!completeBtn) return;

  const orderStarted = {{ order.started_at|default:'None'|yesno:'true,false' }};
  const startedAtStr = '{{ order.started_at|date:"c" }}';
  const estimatedDuration = {{ order.estimated_duration|default:'null' }};

  function redirectToSignature(){
    window.location.href = '{% url "tracker:order_detail" pk=order.id %}';
  }

  completeBtn.addEventListener('click', function(e){
    const orderType = '{{ order.type|default:"" }}';
    if (orderType !== 'service' || !estimatedDuration) {
      redirectToSignature();
      return;
    }

    if (!startedAtStr) { redirectToSignature(); return; }
    const startedAt = new Date(startedAtStr);
    const now = new Date();
    const elapsedMinutes = Math.floor((now - startedAt) / 60000);

    if (elapsedMinutes <= (Number(estimatedDuration) || 0)){
      redirectToSignature();
      return;
    }

    // Exceeded ETA -> show modal to collect reason
    const overrunModalEl = document.getElementById('overrunReasonModal');
    const overrunModal = new bootstrap.Modal(overrunModalEl);
    overrunModal.show();
  });

  // Save reason handler
  const saveBtn = document.getElementById('saveOverrunReasonBtn');
  if (saveBtn){
    saveBtn.addEventListener('click', function(){
      const reason = document.getElementById('overrunReasonInput').value.trim();
      const errEl = document.getElementById('overrunReasonError');
      errEl.style.display = 'none';
      if (!reason){ errEl.textContent = 'Please enter a reason for the delay.'; errEl.style.display = ''; return; }

      fetch('{% url "tracker:api_report_overrun" order_id=order.id %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ reason: reason })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success){
          const modalEl = document.getElementById('overrunReasonModal');
          const modal = bootstrap.Modal.getInstance(modalEl);
          if (modal) modal.hide();
          redirectToSignature();
        } else {
          errEl.textContent = data.error || 'Failed to save reason'; errEl.style.display = '';
        }
      })
      .catch(err => {
        console.error('Error saving overrun reason', err);
        errEl.textContent = 'Server error saving reason'; errEl.style.display = '';
      });
    });
  }
});

// Document Upload and Extraction
function uploadDocument() {
  const fileInput = document.getElementById('documentUploadInput');
  const file = fileInput.files[0];

  if (!file) {
    alert('Please select a file');
    return;
  }

  const formData = new FormData();
  formData.append('file', file);
  formData.append('document_type', 'invoice');
  formData.append('order_id', {{ order.id }});

  const uploadBtn = document.getElementById('uploadDocumentBtn');
  const progressContainer = document.getElementById('uploadProgressContainer');
  const progressBar = document.getElementById('uploadProgressBar');
  const statusText = document.getElementById('uploadStatusText');

  uploadBtn.disabled = true;
  fileInput.disabled = true;
  progressContainer.style.display = 'block';

  fetch('{% url "tracker:api_documents_upload" %}', {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      progressBar.style.width = '100%';
      statusText.textContent = 'Document uploaded! Processing extraction...';

      setTimeout(function() {
        location.reload();
      }, 1000);
    } else {
      alert('Upload failed: ' + (data.error || 'Unknown error'));
      uploadBtn.disabled = false;
      fileInput.disabled = false;
      progressContainer.style.display = 'none';
    }
  })
  .catch(error => {
    console.error('Error uploading document:', error);
    alert('Error uploading document: ' + error.message);
    uploadBtn.disabled = false;
    fileInput.disabled = false;
    progressContainer.style.display = 'none';
  });
}

// Create Invoice from Extraction
function showCreateInvoiceModal(extractionId) {
  fetch('{% url "tracker:api_get_extraction" %}' + '?extraction_id=' + extractionId, {
    method: 'GET',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const extraction = data.extraction;
      document.getElementById('invoiceExtractionId').value = extractionId;

      document.getElementById('previewCustomer').textContent = extraction.extracted_customer_name || '-';
      document.getElementById('previewPlate').textContent = extraction.extracted_vehicle_plate || '-';
      document.getElementById('previewDescription').textContent = extraction.extracted_order_description || '-';
      document.getElementById('previewNetValue').textContent = extraction.net_value || '-';
      document.getElementById('previewVatAmount').textContent = extraction.vat_amount || '-';

      document.getElementById('invoiceReference').value = extraction.reference || extraction.extracted_vehicle_plate || '';

      const modal = new bootstrap.Modal(document.getElementById('createInvoiceFromExtractionModal'));
      modal.show();
    } else {
      alert('Failed to load extraction data: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error loading extraction:', error);
    alert('Error loading extraction data');
  });
}

function submitCreateInvoiceForm() {
  const extractionId = document.getElementById('invoiceExtractionId').value;
  const form = document.getElementById('createInvoiceForm');
  const formData = new FormData(form);

  fetch('{% url "tracker:api_create_invoice_from_extraction" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({
      extraction_id: extractionId,
      order_id: {{ order.id }},
      reference: formData.get('reference'),
      due_date: formData.get('due_date'),
      tax_rate: formData.get('tax_rate'),
      attended_by: formData.get('attended_by'),
      kind_attention: formData.get('kind_attention'),
      notes: formData.get('notes'),
      terms: formData.get('terms')
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const invoiceId = data.invoice_id;
      alert('Invoice created successfully! Redirecting...');
      window.location.href = '/tracker/invoices/' + invoiceId + '/';
    } else {
      alert('Failed to create invoice: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error creating invoice:', error);
    alert('Error creating invoice: ' + error.message);
  });
}
</script>

{% endblock %}
