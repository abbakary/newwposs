{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}

{% block title %}Order {{ order.order_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-md-8">
        <h4>
          <i class="fa fa-play me-2"></i>Order {{ order.order_number }}
          {% if vehicle %}
            <small class="text-muted ms-2"><i class="fa fa-car"></i> {{ vehicle.plate_number }}</small>
          {% endif %}
        </h4>
      </div>
      <div class="col-md-4">
        <ol class="breadcrumb justify-content-end">
          <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><i class="fa fa-home"></i></a></li>
          <li class="breadcrumb-item"><a href="{% url 'tracker:started_orders_dashboard' %}">Started Orders</a></li>
          <li class="breadcrumb-item active">{{ order.order_number }}</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-left border-4" style="border-left-color: #667eea;">
        <div class="card-body py-3">
          <div class="row align-items-center">
            <div class="col-md-6">
              <p class="mb-2"><strong>Status:</strong> <span class="badge bg-secondary">New</span></p>
              <p class="mb-0"><strong>Started:</strong> <span class="text-muted">{{ order.started_at|date:"M d, Y H:i" }}</span></p>
            </div>
            <div class="col-md-6 text-md-end">
              <p class="mb-2"><strong>Type:</strong> 
                {% if order.type == 'service' %}
                  <span class="badge bg-primary"><i class="fa fa-wrench me-1"></i>Service</span>
                {% elif order.type == 'sales' %}
                  <span class="badge bg-success"><i class="fa fa-shopping-cart me-1"></i>Sales</span>
                {% else %}
                  <span class="badge bg-secondary">{{ order.type }}</span>
                {% endif %}
              </p>
              <p class="mb-0"><strong>Progress:</strong> <span class="text-muted">Step 1 of 3</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Action Buttons -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-3 justify-content-center">
            <!-- Customer and Vehicle Info -->
            <div class="btn-group" role="group">
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('customer')">
                <i class="fa fa-user me-2"></i>Customer Info
              </button>
              {% if vehicle %}
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('vehicle')">
                <i class="fa fa-car me-2"></i>Vehicle Info
              </button>
              {% endif %}
            </div>

            <!-- Order Management -->
            <div class="btn-group" role="group">
              <a href="{% url 'tracker:invoice_create_from_order' order_id=order.id %}" class="btn btn-primary">
                <i class="fa fa-plus me-2"></i>Create Invoice
              </a>
              <button type="button" id="uploadInvoiceBtn" class="btn btn-outline-success">
                <i class="fa fa-file-upload me-2"></i>Upload Invoice
              </button>
              <button type="button" id="editOrderDetailsBtn" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editOrderDetailsModal">
                <i class="fa fa-list me-2"></i>Edit Details
              </button>
            </div>

            <!-- Complete Order -->
            <button type="button" id="completeOrderBtn" class="btn btn-success">
              <i class="fa fa-check me-2"></i>Complete Order
            </button>
          </div>

          <!-- Overrun Reason Modal -->
          <div class="modal fade" id="overrunReasonModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                  <h5 class="modal-title">Order Overrun Reason</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <p class="mb-2">This service order has exceeded the expected time. Please provide a reason before completing.</p>
                  <div class="mb-3">
                    <label class="form-label">Reason</label>
                    <textarea id="overrunReasonInput" class="form-control" rows="4" placeholder="Explain why this order exceeded its ETA (required)"></textarea>
                    <div id="overrunReasonError" class="text-danger mt-2" style="display:none;"></div>
                  </div>
                </div>
                <div class="modal-footer bg-light">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" id="saveOverrunReasonBtn" class="btn btn-warning">Save & Continue to Complete</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Hybrid Invoice Modal (Upload + Manual Entry) -->
          <div class="modal fade" id="uploadInvoiceModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content">
                <div class="modal-header bg-light">
                  <h5 class="modal-title">
                    <i class="fa fa-file-invoice me-2"></i>Create Invoice for Order {{ order.order_number }}
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Nav Tabs -->
                <ul class="nav nav-tabs" role="tablist" style="border-bottom: 1px solid #dee2e6; margin: 0; padding: 10px 15px;">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="invoiceUploadTab" data-bs-toggle="tab" data-bs-target="#uploadTabPane" type="button" role="tab">
                      <i class="fa fa-upload me-2"></i>Upload PDF
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="invoiceManualTab" data-bs-toggle="tab" data-bs-target="#manualTabPane" type="button" role="tab">
                      <i class="fa fa-pencil me-2"></i>Enter Manually
                    </button>
                  </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                  <!-- Upload Tab -->
                  <div class="tab-pane fade show active" id="uploadTabPane" role="tabpanel">
                    <div class="modal-body">
                      <div class="alert alert-info mb-3">
                        <small><i class="fa fa-info-circle me-2"></i>Upload a PDF invoice. Text will be extracted and data auto-populated.</small>
                      </div>

                      <div class="mb-3">
                        <label class="form-label fw-bold">Select PDF File</label>
                        <input type="file" id="startedOrderInvoiceFile" class="form-control" accept=".pdf" data-max-file-size="50485760">
                        <small class="text-muted">PDF files only. Max 50MB.</small>
                      </div>

                      <div id="startedUploadError" class="alert alert-danger" style="display:none" role="alert"></div>
                      <div id="startedUploadProgress" class="progress" style="display:none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="startedUploadProgressBar" role="progressbar" style="width: 0%"></div>
                      </div>

                      <div id="uploadedInvoicePreview" style="display:none;" class="card mt-3">
                        <div class="card-header bg-light">
                          <strong><i class="fa fa-check-circle me-2 text-success"></i>Extracted Data Preview</strong>
                        </div>
                        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                          <!-- Customer Information -->
                          <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2"><i class="fa fa-user me-2"></i>Customer Information</h6>
                            <div class="row g-2">
                              <div class="col-md-6">
                                <small class="text-muted d-block">Name</small>
                                <p id="previewCustomerName" class="mb-0">-</p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Phone</small>
                                <p id="previewCustomerPhone" class="mb-0">-</p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Email</small>
                                <p id="previewCustomerEmail" class="mb-0">-</p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Address</small>
                                <p id="previewCustomerAddress" class="mb-0">-</p>
                              </div>
                            </div>
                          </div>

                          <!-- Invoice Information -->
                          <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2"><i class="fa fa-file-invoice me-2"></i>Invoice Information</h6>
                            <div class="row g-2">
                              <div class="col-md-6">
                                <small class="text-muted d-block">Invoice Number</small>
                                <p id="previewInvoiceNo" class="mb-0"><strong>-</strong></p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Invoice Date</small>
                                <p id="previewInvoiceDate" class="mb-0"><strong>-</strong></p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Reference/Code</small>
                                <p id="previewCodeNo" class="mb-0">-</p>
                              </div>
                            </div>
                          </div>


                          <!-- Payment Information -->
                          <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2"><i class="fa fa-money me-2"></i>Payment Summary</h6>
                            <div class="row g-2">
                              <div class="col-md-6">
                                <small class="text-muted d-block">Subtotal</small>
                                <p id="previewSubtotal" class="mb-0">-</p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Tax/VAT</small>
                                <p id="previewTax" class="mb-0">-</p>
                              </div>
                              <div class="col-md-12">
                                <small class="text-muted d-block">Total Amount</small>
                                <p id="previewTotal" class="mb-0 fs-5"><strong>-</strong></p>
                              </div>
                            </div>
                          </div>

                          <!-- Additional Details -->
                          <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2"><i class="fa fa-cog me-2"></i>Transaction Details</h6>
                            <div class="row g-2">
                              <div class="col-md-6">
                                <small class="text-muted d-block">Payment Method</small>
                                <p id="previewPaymentMethod" class="mb-0">-</p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Delivery Terms</small>
                                <p id="previewDeliveryTerms" class="mb-0">-</p>
                              </div>
                            </div>
                          </div>

                          <!-- Attendee Information -->
                          <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2"><i class="fa fa-user-circle me-2"></i>Attendee Information</h6>
                            <div class="row g-2">
                              <div class="col-md-6">
                                <small class="text-muted d-block">Attended By</small>
                                <p id="previewAttendedBy" class="mb-0">-</p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Kind Attention</small>
                                <p id="previewKindAttention" class="mb-0">-</p>
                              </div>
                            </div>
                          </div>

                          <!-- Remarks -->
                          <div class="mb-3">
                            <h6 class="text-muted mb-2"><i class="fa fa-sticky-note me-2"></i>Remarks</h6>
                            <p id="previewRemarks" class="mb-0 small">-</p>
                          </div>

                          <div class="d-flex gap-2 mt-3">
                            <button type="button" id="useExtractedDataBtn" class="btn btn-sm btn-success flex-grow-1">
                              <i class="fa fa-check me-2"></i>Use This Data
                            </button>
                            <button type="button" id="retryUploadBtn" class="btn btn-sm btn-secondary flex-grow-1">
                              <i class="fa fa-refresh me-2"></i>Try Different File
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid #dee2e6;">
                      <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                      <button type="button" id="startedUploadBtn" class="btn btn-primary">
                        <i class="fa fa-upload me-2"></i>Upload & Extract
                      </button>
                    </div>
                  </div>

                  <!-- Manual Entry Tab -->
                  <div class="tab-pane fade" id="manualTabPane" role="tabpanel">
                    <form id="manualInvoiceForm" method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="create_invoice_manual">
                      <input type="hidden" name="selected_order_id" value="{{ order.id }}">
                      {% if vehicle and vehicle.plate_number %}<input type="hidden" name="plate" value="{{ vehicle.plate_number }}">{% endif %}
                      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <!-- Customer Section -->
                        <div class="card mb-3">
                          <div class="card-header bg-light">
                            <strong><i class="fa fa-user me-2"></i>Customer Information</strong>
                          </div>
                          <div class="card-body">
                            <div class="row mb-2">
                              <div class="col-md-6">
                                <label class="form-label">Full Name *</label>
                                <input type="text" name="customer_name" class="form-control" value="{{ order.customer.full_name }}" placeholder="Customer full name" required>
                              </div>
                              <div class="col-md-6">
                                <label class="form-label">Phone *</label>
                                <input type="tel" name="customer_phone" class="form-control" placeholder="Phone number" required>
                              </div>
                            </div>
                            <div class="row mb-2">
                              <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" name="customer_email" class="form-control" placeholder="email@example.com">
                              </div>
                              <div class="col-md-6">
                                <label class="form-label">Type</label>
                                <select name="customer_type" class="form-select">
                                  <option value="personal">Personal</option>
                                  <option value="company">Company</option>
                                  <option value="ngo">NGO</option>
                                  <option value="government">Government</option>
                                </select>
                              </div>
                            </div>
                            <div class="row mb-2">
                              <div class="col-md-12">
                                <label class="form-label">Address</label>
                                <input type="text" name="customer_address" class="form-control" placeholder="Customer address">
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Invoice Section -->
                        <div class="card mb-3">
                          <div class="card-header bg-light">
                            <strong><i class="fa fa-file-invoice me-2"></i>Invoice Information</strong>
                          </div>
                          <div class="card-body">
                            <div class="row mb-2">
                              <div class="col-md-6">
                                <label class="form-label fw-bold">Invoice Number</label>
                                <input type="text" name="invoice_number" class="form-control" placeholder="e.g., INV-001">
                              </div>
                              <div class="col-md-6">
                                <label class="form-label fw-bold">Invoice Date</label>
                                <input type="date" name="invoice_date" class="form-control" value="{% now 'Y-m-d' %}" required>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Payment Section -->
                        <div class="card mb-3">
                          <div class="card-header bg-light">
                            <strong><i class="fa fa-money me-2"></i>Payment Information</strong>
                          </div>
                          <div class="card-body">

                        <div class="row mb-2">
                              <div class="col-md-6">
                                <label class="form-label fw-bold">Subtotal</label>
                                <div class="input-group">
                                  <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                                  <input type="number" name="subtotal" class="form-control manual-amount" step="0.01" min="0" placeholder="0.00">
                                </div>
                              </div>
                              <div class="col-md-6">
                                <label class="form-label fw-bold">Tax/VAT</label>
                                <div class="input-group">
                                  <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                                  <input type="number" name="tax_amount" class="form-control manual-amount" step="0.01" min="0" placeholder="0.00">
                                </div>
                              </div>
                            </div>

                            <div class="row mb-2">
                              <div class="col-md-12">
                                <label class="form-label fw-bold">Total Amount *</label>
                                <div class="input-group">
                                  <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                                  <input type="number" name="total_amount" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <hr>

                        <div class="mb-3">
                          <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">Line Items</label>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="addLineItemBtn">
                              <i class="fa fa-plus me-1"></i>Add Item
                            </button>
                          </div>
                          <div id="lineItemsContainer">
                            <div class="line-item-row card mb-2">
                              <div class="card-body p-2">
                                <div class="row g-2">
                                  <div class="col-md-4">
                                    <input type="text" class="form-control form-control-sm" name="item_description[]" placeholder="Item description" required>
                                  </div>
                                  <div class="col-md-1">
                                    <input type="text" class="form-control form-control-sm" name="item_code[]" placeholder="Code" title="Item code">
                                  </div>
                                  <div class="col-md-1">
                                    <input type="number" class="form-control form-control-sm" name="item_qty[]" placeholder="Qty" value="1" min="1" step="0.01">
                                  </div>
                                  <div class="col-md-1">
                                    <input type="text" class="form-control form-control-sm" name="item_unit[]" placeholder="Unit" title="Unit (PCS, KG, etc)">
                                  </div>
                                  <div class="col-md-2">
                                    <input type="number" class="form-control form-control-sm" name="item_price[]" placeholder="Unit price" step="0.01" min="0" required>
                                  </div>
                                  <div class="col-md-1">
                                    <button type="button" class="btn btn-sm btn-danger remove-item">
                                      <i class="fa fa-trash"></i>
                                    </button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label class="form-label">Payment Method</label>
                            <input type="text" name="payment_method" class="form-control" placeholder="e.g., Cash, Cheque, Bank Transfer">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Delivery Terms</label>
                            <input type="text" name="delivery_terms" class="form-control" placeholder="e.g., ex-stock, FOB">
                          </div>
                        </div>

                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label class="form-label">Attended By</label>
                            <input type="text" name="attended_by" class="form-control" placeholder="Sales Person Name">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Kind Attention</label>
                            <input type="text" name="kind_attention" class="form-control" placeholder="Recipient Name">
                          </div>
                        </div>

                        <div class="mb-3">
                          <label class="form-label">Remarks</label>
                          <textarea name="remarks" class="form-control" rows="2" placeholder="Any remarks or special instructions"></textarea>
                        </div>

                        <div class="mb-3">
                          <label class="form-label">Additional Notes</label>
                          <textarea name="notes" class="form-control" rows="2" placeholder="Any additional notes about this invoice"></textarea>
                        </div>
                      </div>
                      <div class="modal-footer" style="border-top: 1px solid #dee2e6;">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                          <i class="fa fa-save me-2"></i>Create Invoice
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Edit Order Details Modal -->
          <div class="modal fade" id="editOrderDetailsModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title"><i class="fa fa-list me-2"></i>Edit Order Details</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="orderDetailsForm" method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="update_order_details">
                  <div class="modal-body">
                    <!-- Item Selection for Sales Orders -->
                    <div id="itemSelectionSection" class="mb-3" style="display:none;">
                      <label class="form-label fw-bold">Select Item</label>
                      <select id="editOrderItemSelect" name="item_id" class="form-select mb-2">
                        <option value="">Loading items...</option>
                      </select>
                      <div class="row g-2">
                        <div class="col-md-6">
                          <label class="form-label">Brand</label>
                          <input type="text" id="editOrderBrand" name="item_brand" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Quantity</label>
                          <input type="number" id="editOrderQuantity" name="item_quantity" class="form-control" value="1" min="1">
                        </div>
                      </div>
                    </div>

                    <!-- Services/Add-ons Section -->
                    <div id="servicesAddonsSection" class="mb-3">
                      <label class="form-label fw-bold" id="editOrderOptionsLabel">Select Services</label>
                      <div id="orderServicesContainer" class="row g-2">Loading services...</div>
                      <div class="small text-muted mt-2" id="editOrderEtaHint" style="display:none;"></div>
                    </div>

                    <!-- Duration -->
                    <div class="mb-3">
                      <label class="form-label fw-bold">Estimated Duration (minutes)</label>
                      <input type="number" name="estimated_duration" id="orderEstimatedDuration" class="form-control" value="{{ order.estimated_duration|default:'' }}" min="0">
                    </div>
                    <div class="mb-2 text-muted small" id="editOrderHelpText">Selected services will be appended to the order description for quick reference.</div>
                  </div>
                  <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <script>
            // Populate options in Edit Order Details modal
            document.getElementById('editOrderDetailsBtn').addEventListener('click', function(){
              const container = document.getElementById('orderServicesContainer');
              const label = document.getElementById('editOrderOptionsLabel');
              const itemSection = document.getElementById('itemSelectionSection');
              const itemSelect = document.getElementById('editOrderItemSelect');
              const brandField = document.getElementById('editOrderBrand');
              const helpText = document.getElementById('editOrderHelpText');
              const helpSalesText = 'Selected item and add-ons will be saved to the order. Add-ons will be appended to the order description.';
              const helpServiceText = 'Selected services will be appended to the order description for quick reference.';

              container.innerHTML = 'Loading...';
              fetch('{% url "tracker:api_service_types" %}', { method: 'GET', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 'X-Requested-With': 'XMLHttpRequest' }})
                .then(r => {
                  if (!r.ok) {
                    console.error('API response not ok:', r.status, r.statusText);
                  }
                  return r.json();
                })
                .then(data => {
                  console.log('API response data:', data);
                  container.innerHTML = '';
                  const existingDesc = `{{ order.description|default:'' }}`.toLowerCase();
                  const orderType = ('{{ order.type|default:'' }}').toLowerCase();
                  const serviceTypes = Array.isArray(data.service_types) ? data.service_types : [];
                  const addOns = Array.isArray(data.service_addons) ? data.service_addons : [];
                  const inventoryItems = Array.isArray(data.inventory_items) ? data.inventory_items : [];
                  console.log('Inventory items loaded:', inventoryItems.length, inventoryItems);

                  function renderCheckbox(name, mins, isChecked, extraBadge){
                    const safe = (name||'').replace(/[^A-Za-z0-9_]/g,'_');
                    const id = 'od_opt_' + safe;
                    const col = document.createElement('div'); col.className = 'col-md-6';
                    const badge = extraBadge ? ` <span class="badge bg-light text-dark ms-1">${extraBadge}</span>` : '';
                    col.innerHTML = `<div class="form-check">
                      <input class="form-check-input od-option" type="checkbox" id="${id}" name="services" value="${name}" data-minutes="${mins||0}" ${isChecked?'checked':''}>
                      <label class="form-check-label" for="${id}">${name} <span class="text-muted small">(${mins||0}m)</span>${badge}</label>
                    </div>`;
                    container.appendChild(col);
                  }

                  if (orderType === 'sales') {
                    // Show item selection for sales orders
                    itemSection.style.display = 'block';
                    label.textContent = 'Select Add-ons';
                    helpText.textContent = helpSalesText;

                    // Populate item selection
                    itemSelect.innerHTML = '<option value="">Select item</option>';
                    if (inventoryItems.length > 0) {
                      console.log('Adding', inventoryItems.length, 'items to dropdown');
                      inventoryItems.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.brand} - ${item.name}`;
                        option.setAttribute('data-brand', item.brand);
                        itemSelect.appendChild(option);
                      });
                    } else {
                      console.warn('No inventory items available');
                      itemSelect.innerHTML += '<option value="" disabled>No items available</option>';
                    }

                    // Set existing item if available
                    const existingItem = ('{{ order.item_name|default:"" }}').trim();
                    const existingBrand = ('{{ order.brand|default:"" }}').trim();
                    console.log('Existing item:', existingItem, 'Brand:', existingBrand);
                    if (existingItem && inventoryItems.length > 0) {
                      const selectedItem = inventoryItems.find(i => i.name === existingItem && i.brand === existingBrand);
                      if (selectedItem) {
                        console.log('Setting selected item:', selectedItem);
                        itemSelect.value = selectedItem.id;
                        brandField.value = selectedItem.brand;
                      }
                    }

                    // Show add-ons for sales
                    if (addOns.length) {
                      addOns.forEach(add => {
                        const checked = existingDesc.indexOf((add.name||'').toLowerCase()) !== -1;
                        renderCheckbox(add.name, add.estimated_minutes||0, checked, 'Addon');
                      });
                    } else {
                      container.innerHTML = '<div class="text-muted">No add-ons available</div>';
                    }
                  } else {
                    // Hide item selection for service/inquiry orders
                    itemSection.style.display = 'none';
                    label.textContent = 'Select Services';
                    helpText.textContent = helpServiceText;

                    if (serviceTypes.length) {
                      serviceTypes.forEach(svc => {
                        const checked = existingDesc.indexOf((svc.name||'').toLowerCase()) !== -1;
                        renderCheckbox(svc.name, svc.estimated_minutes||0, checked, '');
                      });
                    } else {
                      container.innerHTML = '<div class="text-muted">No services available</div>';
                    }
                    // Also show add-ons below services if present
                    if (addOns.length) {
                      const hr = document.createElement('div'); hr.className = 'col-12 mt-2'; hr.innerHTML = '<hr>'; container.appendChild(hr);
                      addOns.forEach(add => {
                        const checked = existingDesc.indexOf((add.name||'').toLowerCase()) !== -1;
                        renderCheckbox(add.name, add.estimated_minutes||0, checked, 'Addon');
                      });
                    }
                  }

                  // Handle item selection change
                  itemSelect.addEventListener('change', function(){
                    console.log('Item selection changed:', this.value);
                    if (this.value) {
                      const selectedItem = inventoryItems.find(i => i.id === parseInt(this.value));
                      console.log('Selected item found:', selectedItem);
                      if (selectedItem) {
                        console.log('Setting brand field to:', selectedItem.brand);
                        brandField.value = selectedItem.brand;
                      }
                    } else {
                      console.log('Clearing brand field');
                      brandField.value = '';
                    }
                  });

                  // Attach change listeners for ETA
                  container.querySelectorAll('.od-option').forEach(cb => cb.addEventListener('change', updateEditOrderEta));
                  // Initialize ETA on open
                  updateEditOrderEta();
                })
                .catch(err => {
                  console.error('Failed to fetch API:', err);
                  container.innerHTML = '<div class="text-danger">Failed to load options</div>';
                });
            });

            function updateEditOrderEta(){
              const hint = document.getElementById('editOrderEtaHint');
              const etaInput = document.getElementById('orderEstimatedDuration');
              let total = 0;
              document.querySelectorAll('#orderServicesContainer .od-option:checked').forEach(cb => {
                const m = parseInt(cb.getAttribute('data-minutes')||'0',10); if(!isNaN(m)) total += m;
              });
              if (etaInput) { etaInput.value = total > 0 ? String(total) : (etaInput.value || ''); }
              if (hint){
                if (total>0){ hint.style.display='block'; hint.textContent = 'Estimated total time: ' + total + ' mins'; }
                else { hint.style.display='none'; hint.textContent=''; }
              }
            }
          </script>

          <script>
            // Hybrid Invoice Modal Handler (Upload + Manual Entry)
            document.addEventListener('DOMContentLoaded', function(){
              // ===== DOM Elements =====
              const uploadBtn = document.getElementById('uploadInvoiceBtn');
              const modalEl = document.getElementById('uploadInvoiceModal');
              const modal = modalEl ? new bootstrap.Modal(modalEl) : null;

              // Upload Tab elements
              const fileInput = document.getElementById('startedOrderInvoiceFile');
              const startedUploadBtn = document.getElementById('startedUploadBtn');
              const startedUploadError = document.getElementById('startedUploadError');
              const uploadProgress = document.getElementById('startedUploadProgress');
              const uploadProgressBar = document.getElementById('startedUploadProgressBar');
              const uploadedInvoicePreview = document.getElementById('uploadedInvoicePreview');
              const useExtractedDataBtn = document.getElementById('useExtractedDataBtn');
              const retryUploadBtn = document.getElementById('retryUploadBtn');

              // Manual Entry Tab elements
              const manualForm = document.getElementById('manualInvoiceForm');
              const addLineItemBtn = document.getElementById('addLineItemBtn');
              const lineItemsContainer = document.getElementById('lineItemsContainer');

              // Storage for extracted data
              let extractedInvoiceData = null;

              // ===== Utility Functions =====
              function getCSRF(){
                const name = 'csrftoken=';
                const parts = document.cookie.split(';');
                for (let i=0;i<parts.length;i++){ const c = parts[i].trim(); if (c.indexOf(name)===0) return c.substring(name.length); }
                return document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '';
              }

              function showError(message, isDanger = true){
                startedUploadError.style.display = 'block';
                startedUploadError.innerHTML = message;
                startedUploadError.className = isDanger ? 'alert alert-danger' : 'alert alert-warning';
              }

              function showSuccess(message, isDanger = false){
                startedUploadError.style.display = 'block';
                startedUploadError.innerHTML = message;
                startedUploadError.className = 'alert alert-success';
              }

              function resetForm(){
                if (fileInput) fileInput.value = '';
                startedUploadError.style.display = 'none';
                uploadProgress.style.display = 'none';
                uploadedInvoicePreview.style.display = 'none';
                extractedInvoiceData = null;
              }

              // ===== Modal Open Handler =====
              if (uploadBtn){
                uploadBtn.addEventListener('click', function(){
                  resetForm();
                  if (modal) modal.show();
                });
              }

              // ===== Upload Tab Handlers =====
              if (startedUploadBtn){
                startedUploadBtn.addEventListener('click', async function(){
                  startedUploadError.style.display = 'none';

                  // Validate file selection
                  if (!fileInput || !fileInput.files || !fileInput.files[0]){
                    showError('<i class="fa fa-warning me-2"></i>Please select a PDF file to upload.');
                    return;
                  }

                  const file = fileInput.files[0];
                  const maxSizeMB = 50;
                  const maxSizeBytes = maxSizeMB * 1024 * 1024;

                  if (file.size > maxSizeBytes){
                    showError(`<i class="fa fa-warning me-2"></i>File is too large. Maximum size is ${maxSizeMB}MB.`);
                    return;
                  }

                  if (!file.name.toLowerCase().endsWith('.pdf')){
                    showError('<i class="fa fa-warning me-2"></i>Please upload a PDF file (images are not supported).', false);
                    return;
                  }

                  // Build form data
                  const fd = new FormData();
                  fd.append('file', file);
                  fd.append('selected_order_id', '{{ order.id }}');

                  {% if vehicle and vehicle.plate_number %}
                  fd.append('plate', '{{ vehicle.plate_number }}');
                  {% endif %}

                  // Show loading state
                  startedUploadBtn.disabled = true;
                  uploadProgress.style.display = 'block';
                  uploadProgressBar.style.width = '50%';
                  const originalBtnText = startedUploadBtn.innerHTML;
                  startedUploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Extracting...';

                  try {
                    // Step 1: Extract preview data
                    const extractResponse = await fetch('{% url "tracker:api_extract_invoice_preview" %}', {
                      method: 'POST',
                      body: fd,
                      headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRF()
                      }
                    });

                    uploadProgressBar.style.width = '100%';
                    const extractData = await extractResponse.json();

                    if (!extractData.success){
                      uploadProgress.style.display = 'none';
                      const errorMsg = extractData.message || 'Could not extract data from PDF.';
                      showError(`<i class="fa fa-warning me-2"></i>${errorMsg}<br><small>Switch to <strong>Enter Manually</strong> tab to enter details.</small>`, false);
                      return;
                    }

                    // Extraction successful - populate and show form
                    extractedInvoiceData = extractData;
                    populateManualFormWithExtracted(extractData);
                    showExtractedDataPreview(extractData.header, extractData.items);
                    uploadProgress.style.display = 'none';
                    uploadProgressBar.style.width = '0%';

                    // Auto-switch to manual tab to show confirmation form
                    showSuccess('Invoice data extracted! Review and confirm customer details below.', false);
                    setTimeout(() => {
                      document.getElementById('invoiceManualTab').click();
                    }, 500);

                  } catch (err){
                    console.error('Upload error:', err);
                    uploadProgress.style.display = 'none';
                    showError(`<i class="fa fa-exclamation-circle me-2"></i>Upload error: ${err && err.message ? err.message : 'Unknown error'}`);
                  } finally {
                    startedUploadBtn.disabled = false;
                    startedUploadBtn.innerHTML = originalBtnText;
                  }
                });
              }

              function showExtractedDataPreview(header, items){
                // Customer Information
                document.getElementById('previewCustomerName').textContent = header.customer_name || '-';
                document.getElementById('previewCustomerPhone').textContent = header.phone || '-';
                document.getElementById('previewCustomerEmail').textContent = header.email || '-';
                document.getElementById('previewCustomerAddress').textContent = header.address || '-';

                // Invoice Information
                document.getElementById('previewInvoiceNo').textContent = header.invoice_no || '-';
                document.getElementById('previewInvoiceDate').textContent = header.date || '-';
                document.getElementById('previewCodeNo').textContent = header.code_no || header.reference || '-';

                // Line Items
                const itemsContainer = document.getElementById('previewLineItems');
                if (items && items.length > 0) {
                  itemsContainer.innerHTML = items.map((item, idx) => `
                    <div class="d-flex justify-content-between align-items-center mb-1 pb-1 border-bottom">
                      <div>
                        <strong>${item.description || '-'}</strong><br>
                        <small class="text-muted">Qty: ${item.qty || 1}</small>
                      </div>
                      <div class="text-end">
                        <strong>${(item.value || 0).toLocaleString()}</strong>
                      </div>
                    </div>
                  `).join('');
                } else {
                  itemsContainer.innerHTML = '<p class="text-muted">-</p>';
                }

                // Payment Information
                document.getElementById('previewSubtotal').textContent = (header.subtotal || 0).toLocaleString();
                document.getElementById('previewTax').textContent = (header.tax || 0).toLocaleString();
                document.getElementById('previewTotal').textContent = (header.total || 0).toLocaleString();

                // Transaction Details
                document.getElementById('previewPaymentMethod').textContent = header.payment_method || '-';
                document.getElementById('previewDeliveryTerms').textContent = header.delivery_terms || '-';

                // Attendee Information
                document.getElementById('previewAttendedBy').textContent = header.attended_by || '-';
                document.getElementById('previewKindAttention').textContent = header.kind_attention || '-';

                // Remarks
                document.getElementById('previewRemarks').textContent = header.remarks || '-';

                uploadedInvoicePreview.style.display = 'block';
              }

              if (useExtractedDataBtn){
                useExtractedDataBtn.addEventListener('click', function(){
                  if (extractedInvoiceData && extractedInvoiceData.header){
                    // Pre-populate extracted data in the extraction form modal
                    const header = extractedInvoiceData.header;
                    document.querySelector('input[name="extracted_customer_name"]').value = header.customer_name || '';
                    document.querySelector('input[name="extracted_phone"]').value = header.phone || '';
                    document.querySelector('input[name="extracted_email"]').value = header.email || '';
                    document.querySelector('input[name="extracted_address"]').value = header.address || '';
                    document.querySelector('textarea[name="extracted_description"]').value = header.remarks || '';
                    document.querySelector('input[name="extracted_priority"]').value = header.priority || 'medium';

                    // Show the extraction form modal instead of manual form
                    if (window.extractionFormModal) {
                      // Close invoice modal
                      if (modal) modal.hide();
                      // Open extraction form modal
                      window.extractionFormModal.open();
                    } else {
                      // Fallback to manual form
                      populateManualFormWithExtracted(extractedInvoiceData);
                      document.getElementById('invoiceManualTab').click();
                    }
                  }
                });
              }

              if (retryUploadBtn){
                retryUploadBtn.addEventListener('click', function(){
                  resetForm();
                  if (fileInput) fileInput.click();
                });
              }

              function populateManualFormWithExtracted(data){
                const header = data.header || {};
                if (manualForm){
                  // Populate customer fields
                  manualForm.querySelector('input[name="customer_name"]').value = header.customer_name || '';
                  manualForm.querySelector('input[name="customer_phone"]').value = header.phone || '';
                  manualForm.querySelector('input[name="customer_email"]').value = header.email || '';
                  manualForm.querySelector('input[name="customer_address"]').value = header.address || '';

                  // Populate invoice fields
                  manualForm.querySelector('input[name="invoice_number"]').value = header.invoice_no || header.code_no || '';

                  // Handle invoice_date - convert from dd/mm/yyyy to yyyy-mm-dd for HTML date input
                  let invoiceDateValue = '';
                  if (header.date) {
                    const dateMatch = String(header.date).match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                    if (dateMatch) {
                      invoiceDateValue = dateMatch[3] + '-' + String(dateMatch[2]).padStart(2, '0') + '-' + String(dateMatch[1]).padStart(2, '0');
                    } else {
                      invoiceDateValue = header.date;
                    }
                  }
                  manualForm.querySelector('input[name="invoice_date"]').value = invoiceDateValue;

                  manualForm.querySelector('input[name="subtotal"]').value = header.subtotal || '';
                  manualForm.querySelector('input[name="tax_amount"]').value = header.tax || '';
                  manualForm.querySelector('input[name="total_amount"]').value = header.total || '';

                  // Populate additional fields
                  const remarksField = manualForm.querySelector('textarea[name="remarks"]');
                  if (remarksField){
                    remarksField.value = header.remarks || '';
                  }

                  const paymentField = manualForm.querySelector('input[name="payment_method"]');
                  if (paymentField){
                    paymentField.value = header.payment_method || '';
                  }

                  const deliveryField = manualForm.querySelector('input[name="delivery_terms"]');
                  if (deliveryField){
                    deliveryField.value = header.delivery_terms || '';
                  }

                  const attendedField = manualForm.querySelector('input[name="attended_by"]');
                  if (attendedField){
                    attendedField.value = header.attended_by || '';
                  }

                  const kindAttnField = manualForm.querySelector('input[name="kind_attention"]');
                  if (kindAttnField){
                    kindAttnField.value = header.kind_attention || '';
                  }

                  const notesField = manualForm.querySelector('textarea[name="notes"]');
                  if (notesField){
                    notesField.value = header.notes || '';
                  }

                  // Clear existing line items and add extracted ones
                  const existingItems = lineItemsContainer.querySelectorAll('.line-item-row');
                  if (existingItems.length > 0){
                    existingItems.forEach((item, idx) => {
                      if (idx > 0) item.remove();
                    });
                  }

                  // Populate items
                  if (data.items && data.items.length > 0){
                    const firstItem = existingItems[0];
                    data.items.forEach((item, idx) => {
                      if (idx === 0 && firstItem){
                        firstItem.querySelector('input[name="item_description[]"]').value = item.description || '';
                        firstItem.querySelector('input[name="item_code[]"]').value = item.code || '';
                        firstItem.querySelector('input[name="item_qty[]"]').value = item.qty || 1;
                        firstItem.querySelector('input[name="item_unit[]"]').value = item.unit || '';
                        firstItem.querySelector('input[name="item_price[]"]').value = item.rate || item.value || '';
                      } else {
                        addLineItem();
                        const items = lineItemsContainer.querySelectorAll('.line-item-row');
                        const newItem = items[items.length - 1];
                        newItem.querySelector('input[name="item_description[]"]').value = item.description || '';
                        newItem.querySelector('input[name="item_code[]"]').value = item.code || '';
                        newItem.querySelector('input[name="item_qty[]"]').value = item.qty || 1;
                        newItem.querySelector('input[name="item_unit[]"]').value = item.unit || '';
                        newItem.querySelector('input[name="item_price[]"]').value = item.rate || item.value || '';
                      }
                    });
                  }
                }
              }

              // ===== Manual Entry Tab Handlers =====
              function addLineItem(){
                const html = `
                  <div class="line-item-row card mb-2">
                    <div class="card-body p-2">
                      <div class="row g-2">
                        <div class="col-md-4">
                          <input type="text" class="form-control form-control-sm" name="item_description[]" placeholder="Item description" required>
                        </div>
                        <div class="col-md-1">
                          <input type="text" class="form-control form-control-sm" name="item_code[]" placeholder="Code" title="Item code">
                        </div>
                        <div class="col-md-1">
                          <input type="number" class="form-control form-control-sm" name="item_qty[]" placeholder="Qty" value="1" min="1" step="0.01">
                        </div>
                        <div class="col-md-1">
                          <input type="text" class="form-control form-control-sm" name="item_unit[]" placeholder="Unit" title="Unit (PCS, KG, etc)">
                        </div>
                        <div class="col-md-2">
                          <input type="number" class="form-control form-control-sm" name="item_price[]" placeholder="Unit price" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-1">
                          <button type="button" class="btn btn-sm btn-danger remove-item">
                            <i class="fa fa-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
                const div = document.createElement('div');
                div.innerHTML = html;
                const itemRow = div.querySelector('.line-item-row');
                lineItemsContainer.appendChild(itemRow);

                itemRow.querySelector('.remove-item').addEventListener('click', function(e){
                  e.preventDefault();
                  itemRow.remove();
                });
              }

              if (addLineItemBtn){
                addLineItemBtn.addEventListener('click', function(e){
                  e.preventDefault();
                  addLineItem();
                });
              }

              // Remove line item handler (delegated)
              lineItemsContainer.addEventListener('click', function(e){
                if (e.target.closest('.remove-item')){
                  e.preventDefault();
                  e.target.closest('.line-item-row').remove();
                }
              });

              // Handle manual form submission
              if (manualForm){
                manualForm.addEventListener('submit', async function(e){
                  e.preventDefault();

                  // Validate required fields
                  const customerName = this.querySelector('input[name="customer_name"]').value.trim();
                  const customerPhone = this.querySelector('input[name="customer_phone"]').value.trim();
                  const totalAmount = this.querySelector('input[name="total_amount"]').value.trim();

                  if (!customerName || !customerPhone || !totalAmount){
                    showError('<i class="fa fa-warning me-2"></i>Please fill in customer name, phone, and total amount.');
                    return;
                  }

                  const fd = new FormData(this);
                  // Include the originally uploaded file so backend can store it on the Invoice
                  if (typeof fileInput !== 'undefined' && fileInput && fileInput.files && fileInput.files[0]){
                    fd.append('file', fileInput.files[0]);
                  }

                  // Show loading state
                  const submitBtn = this.querySelector('button[type="submit"]');
                  const originalBtnText = submitBtn.innerHTML;
                  submitBtn.disabled = true;
                  uploadProgress.style.display = 'block';
                  uploadProgressBar.style.width = '50%';

                  try {
                    // Call the create-from-upload API endpoint
                    const response = await fetch('{% url "tracker:api_create_invoice_from_upload" %}', {
                      method: 'POST',
                      body: fd,
                      headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRF()
                      }
                    });

                    uploadProgressBar.style.width = '100%';
                    const result = await response.json();

                    if (result.success){
                      showSuccess('<i class="fa fa-check-circle me-2"></i>Invoice created successfully! Redirecting...', false);
                      setTimeout(function(){
                        window.location.href = result.redirect_url || ('/tracker/invoices/' + result.invoice_id + '/');
                      }, 1000);
                    } else {
                      showError(`<i class="fa fa-exclamation-circle me-2"></i>${result.message || 'Failed to create invoice'}`);
                      uploadProgress.style.display = 'none';
                      uploadProgressBar.style.width = '0%';
                    }
                  } catch (err){
                    console.error('Form submission error:', err);
                    showError(`<i class="fa fa-exclamation-circle me-2"></i>Error: ${err.message}`);
                    uploadProgress.style.display = 'none';
                    uploadProgressBar.style.width = '0%';
                  } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                  }
                });
              }

              // Reset form when modal closes
              if (modalEl){
                modalEl.addEventListener('hidden.bs.modal', function(){
                  resetForm();
                });
              }
            });
          </script>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
        <i class="fa fa-eye me-2"></i>Overview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">
        <i class="fa fa-file me-2"></i>Documents <span class="badge bg-danger ms-1">{{ documents.count }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
        <i class="fa fa-list me-2"></i>Order Details
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-user me-2"></i>Customer Information</h6>
            </div>
            <div class="card-body">
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Name</small>
                  <strong>{{ customer.full_name }}</strong>
                </div>
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Phone</small>
                  <strong><a href="tel:{{ customer.phone }}">{{ customer.phone }}</a></strong>
                </div>
                {% if customer.email %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Email</small>
                  <strong><a href="mailto:{{ customer.email }}">{{ customer.email }}</a></strong>
                </div>
                {% endif %}
                {% if customer.address %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Address</small>
                  <strong>{{ customer.address }}</strong>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-car me-2"></i>Vehicle Information</h6>
            </div>
            <div class="card-body">
              {% if vehicle %}
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Plate Number</small>
                  <strong>{{ vehicle.plate_number }}</strong>
                </div>
                {% if vehicle.make %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Make</small>
                  <strong>{{ vehicle.make }}</strong>
                </div>
                {% endif %}
                {% if vehicle.model %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Model</small>
                  <strong>{{ vehicle.model }}</strong>
                </div>
                {% endif %}
                {% if vehicle.vehicle_type %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Type</small>
                  <strong>{{ vehicle.vehicle_type }}</strong>
                </div>
                {% endif %}
              </div>
              {% else %}
              <div class="alert alert-warning" role="alert">
                <i class="fa fa-exclamation-triangle me-2"></i>No vehicle information
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-pane fade" id="documents">
      <!-- Document Upload Section -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-cloud-upload me-2"></i>Upload Invoice/Document</h6>
        </div>
        <div class="card-body">
          <form id="documentUploadForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label">Select Document (PDF preferred)</label>
              <div class="input-group">
                <input type="file" id="documentUploadInput" name="document" accept=".pdf,.txt,.png,.jpg,.jpeg" class="form-control" required>
                <button class="btn btn-primary" type="button" id="uploadDocumentBtn" onclick="uploadDocument()">
                  <i class="fa fa-upload me-1"></i>Upload & Extract
                </button>
              </div>
              <small class="text-muted d-block mt-2">Supported formats: PDF (recommended), Text files, Images. System will extract customer, vehicle, and invoice details automatically.</small>
            </div>
            <div id="uploadProgressContainer" style="display:none;">
              <div class="progress mb-2">
                <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
              </div>
              <small id="uploadStatusText" class="text-muted">Uploading and processing document...</small>
            </div>
          </form>
        </div>
      </div>

      <!-- Uploaded Documents -->
      {% if documents %}
      <div class="row g-3">
        {% for doc in documents %}
        <div class="col-lg-6">
          <div class="card shadow-sm h-100" data-extraction-id="{% if doc.extraction %}{{ doc.extraction.id }}{% else %}{% endif %}">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1"><i class="fa fa-file-pdf me-2" style="color: #dc3545;"></i>{{ doc.file_name }}</h6>
                <small class="text-muted">
                  {{ doc.document_type|upper }}  {{ doc.uploaded_at|date:"M d, Y H:i" }}
                </small>
              </div>
              <span class="badge bg-{% if doc.extraction_status == 'completed' %}success{% elif doc.extraction_status == 'processing' %}warning{% else %}danger{% endif %}">
                {{ doc.extraction_status|title }}
              </span>
            </div>

            <div class="card-body">
              <p class="text-muted">Document uploaded.</p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-info text-center" role="alert">
        <i class="fa fa-info-circle me-2"></i>
        <strong>No documents uploaded yet.</strong> Upload an invoice or quotation to get started.
      </div>
      {% endif %}
    </div>

    <!-- Details Tab -->
    <div class="tab-pane fade" id="details">
      <div class="card shadow-sm">
        <div class="card-body">
          {% if order.description %}
          <div class="mb-3">
            <small class="text-muted d-block">Description</small>
            <strong>{{ order.description }}</strong>
          </div>
          {% endif %}
          {% if order.estimated_duration %}
          <div class="mb-3">
            <small class="text-muted d-block">Estimated Duration</small>
            <strong>{{ order.estimated_duration }} minutes</strong>
          </div>
          {% endif %}
          {% if order.item_name %}
          <div class="mb-3">
            <small class="text-muted d-block">Item</small>
            <strong>{{ order.item_name }}</strong>
          </div>
          {% endif %}
          {% if order.brand %}
          <div class="mb-3">
            <small class="text-muted d-block">Brand</small>
            <strong>{{ order.brand }}</strong>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Include Extraction Form Modal -->
{% include 'tracker/modals/extraction_form_modal.html' %}

<!-- Unified Edit Details Modal -->
<div class="modal fade" id="editDetailsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="fa fa-edit me-2"></i><span id="editTitle">Edit Details</span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <!-- Customer Edit Form -->
      <form id="customerEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_customer">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Full Name</label>
            <input type="text" name="full_name" class="form-control" value="{{ customer.full_name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Phone</label>
            <input type="tel" name="phone" class="form-control" value="{{ customer.phone }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Email</label>
            <input type="email" name="email" class="form-control" value="{{ customer.email|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Address</label>
            <textarea name="address" class="form-control" rows="2">{{ customer.address|default:'' }}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Customer Type</label>
            <select name="customer_type" id="editCustomerType" class="form-select">
              <option value="personal" {% if customer.customer_type == 'personal' %}selected{% endif %}>Personal</option>
              <option value="company" {% if customer.customer_type == 'company' %}selected{% endif %}>Company</option>
              <option value="government" {% if customer.customer_type == 'government' %}selected{% endif %}>Government</option>
              <option value="ngo" {% if customer.customer_type == 'ngo' %}selected{% endif %}>NGO</option>
            </select>
          </div>
          <div class="mb-3 {% if customer.customer_type != 'personal' %}d-none{% endif %}" id="editPersonalSubtypeField">
            <label class="form-label fw-bold">Personal Subtype</label>
            <select name="personal_subtype" class="form-select">
              <option value="owner" {% if customer.personal_subtype == 'owner' %}selected{% endif %}>Owner</option>
              <option value="driver" {% if customer.personal_subtype == 'driver' %}selected{% endif %}>Driver</option>
            </select>
          </div>
          <div class="mb-3 {% if customer.customer_type == 'personal' %}d-none{% endif %}" id="editOrganizationField">
            <label class="form-label fw-bold">Organization Name</label>
            <input type="text" name="organization_name" class="form-control" value="{{ customer.organization_name|default:'' }}">
          </div>
          <div class="mb-3 {% if customer.customer_type == 'personal' %}d-none{% endif %}" id="editTaxField">
            <label class="form-label fw-bold">Tax Number (TIN)</label>
            <input type="text" name="tax_number" class="form-control" value="{{ customer.tax_number|default:'' }}">
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>

      <!-- Vehicle Edit Form -->
      {% if vehicle %}
      <form id="vehicleEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_vehicle">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Plate Number</label>
            <input type="text" class="form-control" value="{{ vehicle.plate_number }}" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Vehicle Type</label>
            <input type="text" name="vehicle_type" class="form-control" value="{{ vehicle.vehicle_type|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Make</label>
            <input type="text" name="make" class="form-control" value="{{ vehicle.make|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Model</label>
            <input type="text" name="model" class="form-control" value="{{ vehicle.model|default:'' }}">
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<script>
let currentEditMode = 'customer';

function setEditMode(mode) {
  currentEditMode = mode;
  
  // Hide all forms
  document.getElementById('customerEditForm').style.display = 'none';
  if (document.getElementById('vehicleEditForm')) {
    document.getElementById('vehicleEditForm').style.display = 'none';
  }
  
  // Show selected form
  if (mode === 'customer') {
    document.getElementById('editTitle').textContent = 'Edit Customer Information';
    document.getElementById('customerEditForm').style.display = 'block';
    // Initialize extra fields visibility when switching to customer form
    if (typeof toggleCustomerExtraFields === 'function') { toggleCustomerExtraFields(); }
  } else if (mode === 'vehicle') {
    document.getElementById('editTitle').textContent = 'Edit Vehicle Information';
    document.getElementById('vehicleEditForm').style.display = 'block';
  }
}

// Dynamically show/hide fields based on customer type
function toggleCustomerExtraFields(){
  var sel = document.getElementById('editCustomerType');
  var type = sel ? String(sel.value).toLowerCase() : '';
  var personal = document.getElementById('editPersonalSubtypeField');
  var org = document.getElementById('editOrganizationField');
  var tax = document.getElementById('editTaxField');
  if (personal) {
    if (type === 'personal') { personal.classList.remove('d-none'); } else { personal.classList.add('d-none'); }
  }
  var showOrg = (type === 'company' || type === 'government' || type === 'ngo');
  if (org) { if (showOrg) { org.classList.remove('d-none'); } else { org.classList.add('d-none'); } }
  if (tax) { if (showOrg) { tax.classList.remove('d-none'); } else { tax.classList.add('d-none'); } }
}

// Attach change listener once DOM is ready
document.addEventListener('DOMContentLoaded', function(){
  var sel = document.getElementById('editCustomerType');
  if (sel) {
    sel.addEventListener('change', toggleCustomerExtraFields);
    toggleCustomerExtraFields();
  }
  // Also wire up when the modal opens, to handle dynamic DOM/visibility
  var editModal = document.getElementById('editDetailsModal');
  if (editModal) {
    editModal.addEventListener('shown.bs.modal', function(){
      var typeSel = document.getElementById('editCustomerType');
      if (typeSel) {
        // avoid double-binding by removing existing then adding
        typeSel.removeEventListener('change', toggleCustomerExtraFields);
        typeSel.addEventListener('change', toggleCustomerExtraFields);
        toggleCustomerExtraFields();
      }
    });
  }
});

// Complete Order Logic
document.addEventListener('DOMContentLoaded', function(){
  const completeBtn = document.getElementById('completeOrderBtn');
  if (!completeBtn) return;

  const orderStarted = {{ order.started_at|default:'None'|yesno:'true,false' }};
  const startedAtStr = '{{ order.started_at|date:"c" }}';
  const estimatedDuration = {{ order.estimated_duration|default:'null' }};

  function redirectToSignature(){
    window.location.href = '{% url "tracker:order_detail" pk=order.id %}';
  }

  completeBtn.addEventListener('click', function(e){
    const orderType = '{{ order.type|default:"" }}';
    if (orderType !== 'service' || !estimatedDuration) {
      redirectToSignature();
      return;
    }

    if (!startedAtStr) { redirectToSignature(); return; }
    const startedAt = new Date(startedAtStr);
    const now = new Date();
    const elapsedMinutes = Math.floor((now - startedAt) / 60000);

    if (elapsedMinutes <= (Number(estimatedDuration) || 0)){
      redirectToSignature();
      return;
    }

    // Exceeded ETA -> show modal to collect reason
    const overrunModalEl = document.getElementById('overrunReasonModal');
    const overrunModal = new bootstrap.Modal(overrunModalEl);
    overrunModal.show();
  });

  // Save reason handler
  const saveBtn = document.getElementById('saveOverrunReasonBtn');
  if (saveBtn){
    saveBtn.addEventListener('click', function(){
      const reason = document.getElementById('overrunReasonInput').value.trim();
      const errEl = document.getElementById('overrunReasonError');
      errEl.style.display = 'none';
      if (!reason){ errEl.textContent = 'Please enter a reason for the delay.'; errEl.style.display = ''; return; }

      fetch('{% url "tracker:api_report_overrun" order_id=order.id %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ reason: reason })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success){
          const modalEl = document.getElementById('overrunReasonModal');
          const modal = bootstrap.Modal.getInstance(modalEl);
          if (modal) modal.hide();
          redirectToSignature();
        } else {
          errEl.textContent = data.error || 'Failed to save reason'; errEl.style.display = '';
        }
      })
      .catch(err => {
        console.error('Error saving overrun reason', err);
        errEl.textContent = 'Server error saving reason'; errEl.style.display = '';
      });
    });
  }
});


</script>

<!-- Extraction Form Modal JavaScript -->
<script src="{% static 'js/extraction_form_modal.js' %}"></script>

<script>
  // Initialize extraction form modal for started orders
  document.addEventListener('DOMContentLoaded', function() {
    // Create hidden inputs for extraction modal to access
    const orderTypeInput = document.createElement('input');
    orderTypeInput.type = 'hidden';
    orderTypeInput.name = 'order_type';
    orderTypeInput.value = '{{ order.type|default:"service" }}';
    document.body.appendChild(orderTypeInput);

    const orderIdInput = document.createElement('input');
    orderIdInput.type = 'hidden';
    orderIdInput.name = 'order_id';
    orderIdInput.value = '{{ order.id }}';
    document.body.appendChild(orderIdInput);
  });
</script>

{% endblock %}
